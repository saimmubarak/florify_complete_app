# Dockerfile for YOLO Plant Detection Lambda Function
# Uses AWS Lambda Python base image with all ML dependencies

FROM public.ecr.aws/lambda/python:3.9

# Install system dependencies for OpenCV and image processing
# Note: opencv-python-headless is headless, so minimal dependencies needed
RUN yum install -y \
    glib2 \
    libgomp \
    && yum clean all

# Copy requirements and install Python dependencies
COPY requirements-yolo.txt ${LAMBDA_TASK_ROOT}/
RUN pip install --no-cache-dir -r requirements-yolo.txt && \
    python -c "import ultralytics; print('✅ ultralytics installed')" && \
    python -c "from PIL import Image; print('✅ PIL installed')" && \
    python -c "import torch; print(f'✅ torch installed: {torch.__version__}')" && \
    python -c "import numpy; print(f'✅ numpy installed: {numpy.__version__}')"

# Copy handler and model
COPY detect_plants_handler.py ${LAMBDA_TASK_ROOT}/
COPY simple_auth.py ${LAMBDA_TASK_ROOT}/
COPY best.pt ${LAMBDA_TASK_ROOT}/

# Set the CMD to your handler (Lambda requires this format)
CMD [ "detect_plants_handler.handler" ]

